<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Meu Projeto</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Montserrat', Arial, sans-serif;
            background: #232b32;
            color: #fff;
        }
        .navbar {
            display: flex;
            align-items: center;
            background: #1a232b;
            padding: 0 0 0 20px;
            height: 56px;
            position: relative;
        }
        .navbar-title {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .navbar-search {
            margin-left: 40px;
            flex: 1;
            display: flex;
            justify-content: center;
        }
        .navbar-search input {
            width: 400px;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            background: #b8c7d1;
            color: #232b32;
            font-size: 1rem;
            outline: none;
        }
        .navbar-icons {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 30px;
        }
        .navbar-icons .icon {
            font-size: 1.7rem;
            color: #fff;
            cursor: pointer;
        }
        .sidebar {
            position: absolute;
            top: 56px;
            left: 0;
            width: 170px;
            height: calc(100vh - 56px);
            background: #2c3e50;
            padding: 24px 0 0 16px;
            box-sizing: border-box;
        }
        .sidebar-user {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 14px;
        }
        .main-content {
            position: absolute;
            top: 56px;
            left: 170px;
            right: 0;
            bottom: 0;
            background: #232b32;
            overflow: hidden;
        }
        .profile-panel {
            position: absolute;
            top: 56px;
            right: 0;
            width: 220px;
            background: #2c3e50;
            padding: 24px 24px 24px 24px;
            box-sizing: border-box;
            color: #fff;
            min-height: 180px;
        }
        .profile-panel h2 {
            margin: 0 0 8px 0;
            font-size: 1.3rem;
            font-weight: 700;
        }
        .profile-panel em {
            font-style: italic;
            font-weight: 700;
            color: #b8c7d1;
        }
        .profile-panel a {
            display: block;
            color: #fff;
            font-weight: 700;
            margin-top: 12px;
            text-decoration: underline;
            font-size: 1.05rem;
        }
        @media (max-width: 700px) {
            .navbar-search input { width: 180px; }
            .sidebar { width: 120px; }
            .main-content { margin-left: 120px; }
            .profile-panel { width: 150px; padding: 16px; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    <div class="navbar">
        <span class="navbar-title">Meu projeto</span>
        <div class="navbar-search">
            <input type="text" placeholder="Pesquisar aqui..">
        </div>
        <div class="navbar-icons">
            <span class="icon" id="bellIcon"><i class="fa-regular fa-bell"></i></span>
            <span class="icon" id="userIcon"><i class="fa-regular fa-user"></i></span>
        </div>
    </div>
    <div class="sidebar">
        <h2 style="font-size:1.1em; color:#b8c7d1; margin-bottom:18px;">Usuários</h2>
        <div id="sidebar-users">Carregando...</div>
    </div>
    <div class="main-content">
        <div id="chat-root"></div>
    </div>
    <div class="notification-panel" id="notificationPanel" style="display:none; position:absolute; top:56px; right:0; width:220px; background:#2c3e50; padding:24px; box-sizing:border-box; color:#fff; min-height:80px; z-index:101; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
        <h2 style="font-size:1.1em; margin-bottom:10px;">Notificações</h2>
        <div style="color:#b8c7d1;">Você não possui nenhuma notificação.</div>
    </div>
    <div class="profile-panel" id="profilePanel" style="display:none;">
        <h2>Bem vindo<br><em id="profile-username">Usuário</em></h2>
        <a href="#">Settings</a>
        <a href="#" id="logout-btn">Logout</a>
    </div>
</body>
    <script src="chat-embed.js"></script>
    <script type="module">
    // Exibe/oculta o painel de perfil ao clicar no ícone de usuário
    const userIcon = document.getElementById('userIcon');
    const profilePanel = document.getElementById('profilePanel');
    const bellIcon = document.getElementById('bellIcon');
    const notificationPanel = document.getElementById('notificationPanel');
    // Exibe o nome do usuário logado
    const username = localStorage.getItem("username") || "Usuário";
    document.getElementById("profile-username").textContent = username;

    userIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        // Fecha painel de notificações se aberto
        notificationPanel.style.display = 'none';
        profilePanel.style.display = profilePanel.style.display === 'none' ? 'block' : 'none';
    });

    bellIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        // Fecha painel de perfil se aberto
        profilePanel.style.display = 'none';
        notificationPanel.style.display = notificationPanel.style.display === 'none' ? 'block' : 'none';
    });

    // Oculta ambos os painéis se clicar fora deles
    document.addEventListener('click', function(e) {
        if (profilePanel.style.display === 'block' && !profilePanel.contains(e.target) && e.target !== userIcon && !userIcon.contains(e.target)) {
            profilePanel.style.display = 'none';
        }
        if (notificationPanel.style.display === 'block' && !notificationPanel.contains(e.target) && e.target !== bellIcon && !bellIcon.contains(e.target)) {
            notificationPanel.style.display = 'none';
        }
    });

    // Botão de logout
    document.getElementById('logout-btn').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('username');
        window.location.href = 'https://gabellaurent.github.io/projetoPessoalRP/index.html';
    });

    // SUPABASE: Listar usuários na sidebar
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabaseUrl = 'https://xhybbhdhjaluqjrtopml.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoeWJiaGRoamFsdXFqcnRvcG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzQ5NjMsImV4cCI6MjA2ODg1MDk2M30.Xb98A6l-duDBO6G8_3SPKwluyAm-v8LH5G22ysmSXck';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let lastSidebarState = '';
    async function listarUsuariosSidebar() {
        const sidebarUsers = document.getElementById('sidebar-users');
        const { data, error } = await supabase
            .from('base-users')
            .select('username, lastActive');
        if (error) {
            sidebarUsers.innerHTML = '<div style="color:#e74c3c;">Erro ao carregar usuários.</div>';
            console.error('Erro ao buscar usuários:', error.message);
            return;
        }
        if (!data || data.length === 0) {
            sidebarUsers.innerHTML = '<div style="color:#b8c7d1;">Nenhum usuário encontrado.</div>';
            return;
        }
        // Separar online e offline com base no lastActive
        const now = Date.now();
        const onlineUsers = data.filter(u => {
            if (!u.lastActive) return false;
            const lastActive = new Date(u.lastActive).getTime();
            return (now - lastActive) < 70000;
        });
        const offlineUsers = data.filter(u => {
            if (!u.lastActive) return true;
            const lastActive = new Date(u.lastActive).getTime();
            return (now - lastActive) >= 70000;
        });
        // Gera uma string representando o estado atual
        const sidebarState = JSON.stringify({
            online: onlineUsers.map(u => u.username),
            offline: offlineUsers.map(u => u.username)
        });
        // Só atualiza o DOM se houver mudança
        if (sidebarState !== lastSidebarState) {
            sidebarUsers.innerHTML = '';
            onlineUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'sidebar-user';
                div.textContent = user.username;
                div.style.color = '#fff';
                sidebarUsers.appendChild(div);
            });
            offlineUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'sidebar-user';
                div.textContent = user.username;
                div.style.color = '#b8c7d1';
                sidebarUsers.appendChild(div);
            });
            lastSidebarState = sidebarState;
        }
    }
    listarUsuariosSidebar();

    // Atualização em tempo real dos usuários registrados
    supabase
      .channel('public:base-users')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'base-users' }, payload => {
        listarUsuariosSidebar();
      })
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'base-users' }, payload => {
        listarUsuariosSidebar();
      })
      .subscribe();

    // Heartbeat: atualiza lastActive a cada 60s
    setInterval(async () => {
        const username = localStorage.getItem('username');
        if (username) {
            // Busca o id do usuário
            const { data } = await supabase
                .from('base-users')
                .select('id')
                .eq('username', username)
                .single();
            if (data && data.id) {
                await supabase
                    .from('base-users')
                    .update({ lastActive: new Date().toISOString() })
                    .eq('id', data.id);
            }
        }
    }, 60000);

    // Atualiza lastActive ao carregar a página (indica que o usuário entrou)
    (async () => {
        const username = localStorage.getItem('username');
        if (username) {
            const { data } = await supabase
                .from('base-users')
                .select('id')
                .eq('username', username)
                .single();
            if (data && data.id) {
                await supabase
                    .from('base-users')
                    .update({ lastActive: new Date().toISOString() })
                    .eq('id', data.id);
            }
        }
    })();
    </script>
</html>