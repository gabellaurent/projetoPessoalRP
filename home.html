<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Meu Projeto</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="home.css">
</head>
<body style="display:none;">
    <div class="navbar">
        <a class="navbar-title" href="#" id="homeLink">MinhaApp</a>
        <div class="navbar-search">
            <input type="text" placeholder="Pesquisar aqui..">
        </div>
        <div class="navbar-icons">
            <span class="icon" id="bellIcon"><i class="fa-regular fa-bell"></i></span>
            <span class="icon" id="chatIcon" title="Abrir Chat" style="position:relative;">
              <i class="fa-regular fa-comment"></i>
              <span id="chat-badge" style="display:none;position:absolute;top:-3px;right:-3px;background:#e74c3c;color:#fff;font-size:0.62em;font-weight:bold;padding:1px 4px;border-radius:8px;min-width:10px;text-align:center;z-index:2;pointer-events:none;box-shadow:0 1px 4px #0002;transform:scale(0.7);">0</span>
            </span>
            <span class="icon" id="criarPostagemBtn" title="Criar Postagem" style="display:inline-flex;align-items:center;gap:6px;padding:0 10px;cursor:pointer;font-weight:600;color:#fff;font-size: 1.3rem;">
              <i class="fa-solid fa-plus"></i> <span style="font-size:1em;">Criar Postagem</span>
            </span>
            <span class="icon" id="userIcon"><i class="fa-regular fa-user"></i></span>
        </div>
    </div>
    <div class="sidebar">
        <h2 style="font-size:1.1em; color:#b8c7d1; margin-bottom:18px;">Usuários</h2>
        <div id="sidebar-users">Carregando...</div>
    </div>
    <div class="main-content" style="overflow-y:auto;max-height:calc(100vh - 56px);scrollbar-width:none;-ms-overflow-style:none;">
        <div id="chat-root" style="display:none;"></div>
    </div>
    <div class="notification-panel" id="notificationPanel" style="display:none; position:absolute; top:56px; right:0; width:220px; background:#2c3e50; padding:24px; box-sizing:border-box; color:#fff; min-height:80px; z-index:101; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
        <h2 style="font-size:1.1em; margin-bottom:10px;">Notificações</h2>
        <div style="color:#b8c7d1;">Você não possui nenhuma notificação.</div>
    </div>
    <div class="profile-panel" id="profilePanel" style="display:none;">
        <h2>Bem vindo<br><em id="profile-username">Usuário</em></h2>
        <a href="#">Settings</a>
        <a href="#" id="logout-btn">Logout</a>
    </div>
    <script src="chat-embed.js"></script>
    <script type="module" src="home.js"></script>
    <script>
      // Carrega main-content.js dinamicamente ao clicar no título
      document.addEventListener('DOMContentLoaded', function() {
        var homeLink = document.getElementById('homeLink');
        if (homeLink) {
          homeLink.addEventListener('click', function(e) {
            e.preventDefault();
            // Remove o script antigo se existir
            var oldScript = document.querySelector('script[src="main-content.js"]');
            if (oldScript) oldScript.remove();
            // Cria novo script
            var script = document.createElement('script');
            script.src = 'main-content.js';
            script.onload = function() {
              if (window.renderMainContent) window.renderMainContent('.main-content');
            };
            document.body.appendChild(script);
          });
        }
      });
    </script>
    <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabaseUrl = 'https://xhybbhdhjaluqjrtopml.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoeWJiaGRoamFsdXFqcnRvcG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzQ5NjMsImV4cCI6MjA2ODg1MDk2M30.Xb98A6l-duDBO6G8_3SPKwluyAm-v8LH5G22ysmSXck';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Garante que a flag global está definida como fechado ao carregar a página
    window.chatIsOpen = false;
    document.addEventListener('DOMContentLoaded', function() {
      var chatIcon = document.getElementById('chatIcon');
      var chatRoot = document.getElementById('chat-root');
      var chatBadge = document.getElementById('chat-badge');
      // Garante que o chat começa fechado
      if (chatRoot) {
        chatRoot.innerHTML = '';
        chatRoot.style.display = 'none';
      }
      // Função para resetar badge ao abrir o chat
      function resetChatBadge() {
        if (chatBadge) {
          chatBadge.style.display = 'none';
          chatBadge.textContent = '0';
        }
        // Salva o último id da mensagem lida
        supabase
          .from('meu-chat')
          .select('id')
          .order('created_at', { ascending: false })
          .limit(1)
          .then(({ data }) => {
            if (data && data.length > 0) {
              localStorage.setItem('lastChatMsgId', data[0].id);
            }
          });
      }
      chatIcon.addEventListener('click', function() {
        // Zera badge imediatamente ao clicar, mesmo antes do chat renderizar
        unreadCount = 0;
        if (chatBadge) {
          chatBadge.style.display = 'none';
          chatBadge.textContent = '0';
        }
        if (chatRoot && (chatRoot.innerHTML.trim() === '' || chatRoot.style.display === 'none')) {
          // Remove o script antigo se existir
          var oldScript = document.querySelector('script[src="chat-embed.js"]');
          if (oldScript) oldScript.remove();
          // Cria novo script
          var script = document.createElement('script');
          script.src = 'chat-embed.js';
          document.body.appendChild(script);
          chatRoot.style.display = '';
          resetChatBadge();
        }
      });

      // Botão Criar Postagem
      var criarBtn = document.getElementById('criarPostagemBtn');
      criarBtn.addEventListener('click', function() {
        var oldScript = document.querySelector('script[src="main-content.js"]');
        if (oldScript) oldScript.remove();
        if (!window.renderCriarPostagem) {
          var script = document.createElement('script');
          script.src = 'criar-postagem.js';
          script.onload = function() {
            window.renderCriarPostagem('.main-content');
          };
          document.body.appendChild(script);
        } else {
          window.renderCriarPostagem('.main-content');
        }
      });

      // Badge: escuta realtime do chat
      let lastMsgId = localStorage.getItem('lastChatMsgId');
      let unreadCount = 0;
      // Busca o último id ao carregar
      supabase
        .from('meu-chat')
        .select('id')
        .order('created_at', { ascending: false })
        .limit(1)
        .then(({ data }) => {
          if (data && data.length > 0) {
            if (!lastMsgId) {
              localStorage.setItem('lastChatMsgId', data[0].id);
              lastMsgId = data[0].id;
            }
          }
        });
      // Realtime: incrementa badge se nova mensagem
         // Realtime: incrementa badge se nova mensagem
      supabase
        .channel('public:meu-chat')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'meu-chat' }, payload => {
          const newId = payload.new.id;
          // Só conta se o chat estiver realmente fechado (flag global) E a mensagem não for do próprio usuário
          let isChatOpen = window.chatIsOpen === true;
          let username = localStorage.getItem('username') || '';
          let isOwnMessage = (payload.new.usuario && payload.new.usuario === username);
          if (!isChatOpen && !isOwnMessage) {
            if (!lastMsgId) lastMsgId = newId;
            if (newId !== lastMsgId) {
              unreadCount++;
              chatBadge.textContent = unreadCount > 99 ? '99+' : '+' + unreadCount;
              chatBadge.style.display = 'inline-block';
            }
          } else {
            // Se o chat está aberto ou a mensagem é do próprio usuário, reseta
            resetChatBadge();
            unreadCount = 0;
            lastMsgId = newId;
          }
        })
        .subscribe();
    });
    </script>
</body>
</html>